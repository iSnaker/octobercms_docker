#!/bin/bash
set -e

echo 'Initializing container'

# Fix permissions for October CMS directories
echo 'Setting proper permissions for storage, plugins, and themes directories...'
chown -R www-data:www-data /var/www/html/storage /var/www/html/plugins /var/www/html/themes 2>/dev/null || true
chmod -R 775 /var/www/html/storage /var/www/html/plugins /var/www/html/themes 2>/dev/null || true

# Ensure logs directory exists and is writable
mkdir -p /var/www/html/storage/logs
chmod -R 775 /var/www/html/storage/logs
chown -R www-data:www-data /var/www/html/storage/logs

# PHP config
if [ ! -z "$PHP_DISPLAY_ERRORS" ]; then
  echo "php.ini set display_errors=$PHP_DISPLAY_ERRORS"
  sed -i "/display_errors=*/c\display_errors=$PHP_DISPLAY_ERRORS" /usr/local/etc/php/conf.d/docker-oc-php.ini
fi

if [ ! -z "$PHP_POST_MAX_SIZE" ]; then
  echo "php.ini set post_max_size=$PHP_POST_MAX_SIZE"
  sed -i "/post_max_size=*/c\post_max_size=$PHP_POST_MAX_SIZE" /usr/local/etc/php/conf.d/docker-oc-php.ini
fi

if [ ! -z "$PHP_MEMORY_LIMIT" ]; then
  echo "php.ini set memory_limit=$PHP_MEMORY_LIMIT"
  sed -i "/memory_limit=*/c\memory_limit=$PHP_MEMORY_LIMIT" /usr/local/etc/php/conf.d/docker-oc-php.ini
fi

if [ ! -z "$PHP_UPLOAD_MAX_FILESIZE" ]; then
  echo "php.ini set upload_max_filesize=$PHP_UPLOAD_MAX_FILESIZE"
  sed -i "/upload_max_filesize=*/c\upload_max_filesize=$PHP_UPLOAD_MAX_FILESIZE" /usr/local/etc/php/conf.d/docker-oc-php.ini
fi

if [ ! -z "$PHP_UPLOAD_MAX_FILESIZE" ]; then
  echo "php.ini set upload_max_filesize=$PHP_UPLOAD_MAX_FILESIZE"
  sed -i "/upload_max_filesize=*/c\upload_max_filesize=$PHP_UPLOAD_MAX_FILESIZE" /usr/local/etc/php/conf.d/docker-oc-php.ini
fi

# Xdebug config
if [ "${XDEBUG_ENABLE,,}" == "true" ]; then
  if [ ! -f "/usr/local/etc/php/conf.d/docker-xdebug-php.ini" ]; then
    echo "Xdebug config not found. Try the develop image" && exit 1;
  fi
  sed -i "/zend_extension/s/^#//" /usr/local/etc/php/conf.d/docker-xdebug-php.ini
  echo 'Xdebug enabled'
fi

if [ ! -z "$XDEBUG_REMOTE_HOST" ]; then
  if [ ! -f "/usr/local/etc/php/conf.d/docker-xdebug-php.ini" ]; then
    echo "Xdebug config not found. Try the develop image" && exit 1;
  fi
  echo "set xdebug.remote_host=$XDEBUG_REMOTE_HOST"
  sed -i "/xdebug.remote_host=*/c\xdebug.remote_host=$XDEBUG_REMOTE_HOST" /usr/local/etc/php/conf.d/docker-xdebug-php.ini
fi

# Display current commit, php version, and dependency info
if [ "${VERSION_INFO,,}" == "true" ]; then
  echo -e "October CMS - $OCTOBERCMS_TAG\n---"
  if [ -d ".git" ]; then
    git log --pretty=format:"%s%n%C(yellow)%H%Creset" -1
    echo -e "\n---"
  fi
  php --version | grep PHP -m 1
  composer info | grep october | awk '{print $1 ": " $2}'
  echo "---"
fi

# Checkout branch, tag, commit within the container
if [ ! -z "$GIT_CHECKOUT" ]; then
  if [ ! -d ".git" ]; then
    error "Git repo is not found. Try the develop image" && exit 1;
  fi
  echo "Checking out $GIT_CHECKOUT...";
  git checkout $GIT_CHECKOUT
  git log --pretty=format:"%s%n%C(yellow)%H%Creset" -1
  echo -e "\n---"
fi

# Pass GitHub pull request number to merge PR within the container for testing
if [ ! -z "$GIT_MERGE_PR" ]; then
  if [ ! -d ".git" ]; then
    error "Git repo is not found. Try the develop image" && exit 1;
  fi

  echo "Test GitHub pull request #$GIT_MERGE_PR";
  curl -fsS --connect-timeout 15 \
    https://api.github.com/repos/octobercms/october/pulls/$GIT_MERGE_PR \
    | jq -r '.title, .html_url';
  echo "---"

  echo "Fetch..."
  git fetch origin pull/$GIT_MERGE_PR/head:pr-$GIT_MERGE_PR

  echo "Merge..."
  git merge --no-commit pr-$GIT_MERGE_PR || { error "Check if PR $GIT_MERGE_PR exists." && exit 1; }

  echo "Diff..."
  git diff --cached --stat
  echo "---"
fi

# Enable remote IP forwarding for proxy support
if [[ "$1" == apache2* ]] && [ "${FWD_REMOTE_IP,,}" == "true" ]; then
  a2enmod remoteip -q
  echo 'RemoteIPHeader X-Forwarded-For' > $APACHE_CONFDIR/conf-available/docker-oc-apache.conf
  a2enconf docker-oc-apache -q
fi

# Start a cron process within the container
if [ "${ENABLE_CRON,,}" == "true" ]; then
  php artisan schedule:run # required to prime db connection
  cron
  echo 'Cron enabled.'
elif [ "$1" == cron ]; then
  php artisan schedule:run
fi

# Initialize vendor plugins where vendor folder isn't detected
if [ "${INIT_PLUGINS,,}" == "true" ] || [ "${INIT_PLUGINS,,}" == "force" ]; then
  echo 'Initializing plugin vendor folders...'
  for i in $(echo plugins/*/*); do
    if [ -f "$i/composer.json" ]; then
      if [ "${INIT_PLUGINS,,}" == "force" ] || [ ! -d "$i/vendor" ]; then
        echo " - $i"
        composer --working-dir="$i" --no-interaction --quiet install
        chown -R www-data:www-data $i
      fi
    fi
  done
fi

OCTOBER_UPDATE_MANAGER="modules/system/classes/UpdateManager.php"

apply_october_patch() {
     if [ ! -f "$OCTOBER_UPDATE_MANAGER" ]; then
       echo "[entrypoint] UpdateManager.php not found, skipping patch"
       return
     fi

     # Check if line 890 is already commented or patch already applied
     if sed -n '890p' "$OCTOBER_UPDATE_MANAGER" | grep -q "^[[:space:]]*//"; then
       echo "[entrypoint] Patch already applied (line 890 is commented)"
       return
     fi

     echo "[entrypoint] Applying October CMS patch: commenting out line 890 in UpdateManager.php"

     # Comment out line 890
     sed -i.bak '890s#^#// #' "$OCTOBER_UPDATE_MANAGER"

     echo "[entrypoint] Patch applied successfully"
   }


   APP_ENV_VALUE="${APP_ENV:-production}"

      echo "[entrypoint] APP_ENV=$APP_ENV_VALUE"

      if [ "$APP_ENV_VALUE" != "production" ]; then
        echo "[entrypoint] Non-production environment detected, applying patch..."
        apply_october_patch
      else
        echo "[entrypoint] Production environment detected, patch NOT applied"
      fi

 # Run october up on container start - check if first run
 if [ ! -f "/var/www/html/storage/.october_installed" ]; then
   echo 'Initializing October CMS (first run detected)...'

   # Install October CMS
   echo "Running october:install..."
   php artisan october:install --no-interaction

  # Generate application key if not exists
  if ! grep -q "APP_KEY=" .env || [ -z "$(grep APP_KEY= .env | cut -d '=' -f2)" ]; then
        echo "Generating application key..."
        php artisan key:generate
  fi

  # Run migrations to create system database tables FIRST
     echo "Running initial database migrations to create system tables..."
     php artisan october:up

  # Install plugins from OCTOBER_PLUGINS environment variable AFTER system tables are created
  # This ensures dependencies are installed before custom mounted plugins are initialized
     if [ ! -z "$OCTOBER_PLUGINS" ]; then
       echo "Installing plugins from OCTOBER_PLUGINS: $OCTOBER_PLUGINS"

       # Split plugins by comma and install each one
       IFS=',' read -ra PLUGINS <<< "$OCTOBER_PLUGINS"
       for plugin in "${PLUGINS[@]}"; do
         # Trim whitespace
         plugin=$(echo "$plugin" | xargs)

         if [ ! -z "$plugin" ]; then
           echo "Installing plugin: $plugin"
           php artisan plugin:install "$plugin" || echo "Warning: Failed to install $plugin"
         fi
       done
     else
       echo "No plugins specified in OCTOBER_PLUGINS, skipping plugin installation"
     fi

  # set default admin user credentials
     echo "Setting default admin/admin user credentials..."
     php artisan october:passwd admin admin

     echo "Removing demo plugin and theme"
     php artisan october:fresh

  # Mark as installed
     touch /var/www/html/storage/.october_installed
     echo "October CMS installation completed!"
 else
   echo "October CMS already initialized (found .october_installed marker)"
 fi

exec "$@"
